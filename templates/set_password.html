{% extends 'auth_base.html' %}

{% block title %}Parol o'rnatish{% endblock title %}

{% block auth_content %}
<div class="login-logo mb-3">
  <b>TG Yuk</b> Monitor
</div>

<p class="login-box-msg">
  <i class="fas fa-user-lock text-success"></i> Login va parol o'rnatish
</p>

<div class="alert alert-success alert-dismissible fade show">
  <i class="fas fa-check-circle"></i>
  <strong>Tasdiqlandi!</strong><br>
  Endi tizimga kirish uchun login va parol o'rnating.
  <button type="button" class="close" data-dismiss="alert">&times;</button>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
  {% endfor %}
{% endif %}

<!-- Login va Parol o'rnatish form -->
<form method="post" id="setPasswordForm">
  {% csrf_token %}

  <!-- Username (Login) -->
  <div class="input-group mb-3">
    <input 
      type="text" 
      name="username" 
      class="form-control" 
      placeholder="Login (username)" 
      required 
      autofocus
      id="username"
      minlength="3"
      maxlength="30"
    >
    <div class="input-group-append">
      <div class="input-group-text">
        <span class="fas fa-user"></span>
      </div>
    </div>
  </div>

  <!-- Yangi parol -->
  <div class="input-group mb-3">
    <input 
      type="password" 
      name="password1" 
      class="form-control" 
      placeholder="Yangi parol" 
      required
      id="password1"
      minlength="6"
    >
    <div class="input-group-append">
      <div class="input-group-text">
        <span class="fas fa-lock"></span>
      </div>
    </div>
  </div>

  <!-- Parolni takrorlash -->
  <div class="input-group mb-3">
    <input 
      type="password" 
      name="password2" 
      class="form-control" 
      placeholder="Parolni takrorlang" 
      required
      id="password2"
      minlength="6"
    >
    <div class="input-group-append">
      <div class="input-group-text">
        <span class="fas fa-lock"></span>
      </div>
    </div>
  </div>

  <!-- Ko'rsatish checkbox -->
  <div class="form-check mb-3">
    <input type="checkbox" class="form-check-input" id="showPassword">
    <label class="form-check-label" for="showPassword" style="font-size: 13px;">
      <i class="fas fa-eye"></i> Parolni ko'rsatish
    </label>
  </div>

  <!-- Parol kuchi indikatori -->
  <div class="mb-3">
    <small class="text-muted">Parol kuchi:</small>
    <div class="progress" style="height: 8px;">
      <div 
        class="progress-bar" 
        role="progressbar" 
        id="strengthBar"
        style="width: 0%"
      ></div>
    </div>
    <small id="strengthText" class="text-muted"></small>
  </div>

  <div class="row">
    <div class="col-12">
      <button type="submit" class="btn btn-success btn-block" id="submitBtn">
        <i class="fas fa-check"></i> Saqlash va kirish
      </button>
    </div>
  </div>
</form>

<!-- Talablar -->
<div class="mt-3 p-3" style="background-color: #d1ecf1; border-radius: 10px; border-left: 4px solid #17a2b8;">
  <p class="mb-2" style="font-size: 13px; color: #0c5460;">
    <i class="fas fa-shield-alt"></i> <strong>Talablar:</strong>
  </p>
  <ul class="mb-0 pl-3" style="font-size: 12px; color: #0c5460;" id="requirements">
    <li id="req-username">
      <i class="fas fa-circle text-muted" style="font-size: 6px;"></i>
      Login: kamida 3 ta belgi (faqat harf, raqam, _)
    </li>
    <li id="req-length">
      <i class="fas fa-circle text-muted" style="font-size: 6px;"></i>
      Parol: kamida 6 ta belgi
    </li>
    <li id="req-match">
      <i class="fas fa-circle text-muted" style="font-size: 6px;"></i>
      Ikkala parol bir xil bo'lishi kerak
    </li>
    <li id="req-strong">
      <i class="fas fa-circle text-muted" style="font-size: 6px;"></i>
      Kuchli parol tavsiya etiladi (harflar, raqamlar, belgilar)
    </li>
  </ul>
</div>

<!-- Maslahatlar -->
<div class="mt-3 p-3" style="background-color: #fff3cd; border-radius: 10px;">
  <p class="mb-2" style="font-size: 13px; color: #856404;">
    <i class="fas fa-lightbulb"></i> <strong>Xavfsizlik maslahatlari:</strong>
  </p>
  <ul class="mb-0 pl-3" style="font-size: 12px; color: #856404;">
    <li>Login: faqat lotin harflari, raqamlar va _ belgisidan foydalaning</li>
    <li>Oson parollardan foydalanmang (123456, qwerty, va h.k.)</li>
    <li>Katta-kichik harflar, raqamlar va belgilarni aralashtiring</li>
    <li>Parolni hech kimga aytmang</li>
  </ul>
</div>

{% endblock auth_content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('setPasswordForm');
  const submitBtn = document.getElementById('submitBtn');
  const username = document.getElementById('username');
  const password1 = document.getElementById('password1');
  const password2 = document.getElementById('password2');
  const showPassword = document.getElementById('showPassword');
  const strengthBar = document.getElementById('strengthBar');
  const strengthText = document.getElementById('strengthText');

  // Username input - faqat ruxsat etilgan belgilar
  username.addEventListener('input', function() {
    // Faqat lotin harflari, raqamlar va _ qoldirish
    this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '');
    updateRequirements();
  });

  // Parolni ko'rsatish/yashirish
  showPassword.addEventListener('change', function() {
    const type = this.checked ? 'text' : 'password';
    password1.type = type;
    password2.type = type;
    
    // Icon o'zgartirish
    const icon = this.nextElementSibling.querySelector('i');
    icon.className = this.checked ? 'fas fa-eye-slash' : 'fas fa-eye';
  });

  // Parol kuchini tekshirish
  function checkPasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 6) strength += 20;
    if (password.length >= 10) strength += 20;
    if (/[a-z]/.test(password)) strength += 20;
    if (/[A-Z]/.test(password)) strength += 20;
    if (/[0-9]/.test(password)) strength += 10;
    if (/[^a-zA-Z0-9]/.test(password)) strength += 10;
    
    return strength;
  }

  // Parol kuchi ko'rsatkichi
  password1.addEventListener('input', function() {
    const strength = checkPasswordStrength(this.value);
    
    strengthBar.style.width = strength + '%';
    
    if (strength < 40) {
      strengthBar.className = 'progress-bar bg-danger';
      strengthText.textContent = 'Zaif';
      strengthText.className = 'text-danger';
    } else if (strength < 70) {
      strengthBar.className = 'progress-bar bg-warning';
      strengthText.textContent = 'O\'rtacha';
      strengthText.className = 'text-warning';
    } else {
      strengthBar.className = 'progress-bar bg-success';
      strengthText.textContent = 'Kuchli';
      strengthText.className = 'text-success';
    }
    
    // Talablarni tekshirish
    updateRequirements();
  });

  // Parol mos kelishini tekshirish
  password2.addEventListener('input', updateRequirements);

  function updateRequirements() {
    const un = username.value;
    const p1 = password1.value;
    const p2 = password2.value;
    
    // Username tekshirish
    const reqUsername = document.getElementById('req-username');
    if (un.length >= 3 && /^[a-zA-Z0-9_]+$/.test(un)) {
      reqUsername.innerHTML = '<i class="fas fa-check-circle text-success"></i> Login to\'g\'ri';
    } else if (un.length > 0 && un.length < 3) {
      reqUsername.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Login juda qisqa';
    } else {
      reqUsername.innerHTML = '<i class="fas fa-circle text-muted" style="font-size: 6px;"></i> Login: kamida 3 ta belgi';
    }
    
    // Parol uzunligi
    const reqLength = document.getElementById('req-length');
    if (p1.length >= 6) {
      reqLength.innerHTML = '<i class="fas fa-check-circle text-success"></i> Parol uzunligi yetarli';
    } else if (p1.length > 0) {
      reqLength.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Parol juda qisqa';
    } else {
      reqLength.innerHTML = '<i class="fas fa-circle text-muted" style="font-size: 6px;"></i> Parol: kamida 6 ta belgi';
    }
    
    // Parollar mos kelishi
    const reqMatch = document.getElementById('req-match');
    if (p1 && p2 && p1 === p2) {
      reqMatch.innerHTML = '<i class="fas fa-check-circle text-success"></i> Parollar bir xil';
    } else if (p2) {
      reqMatch.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Parollar mos kelmayapti';
    } else {
      reqMatch.innerHTML = '<i class="fas fa-circle text-muted" style="font-size: 6px;"></i> Ikkala parol bir xil bo\'lishi kerak';
    }
    
    // Parol kuchliligi
    const reqStrong = document.getElementById('req-strong');
    const strength = checkPasswordStrength(p1);
    if (strength >= 70) {
      reqStrong.innerHTML = '<i class="fas fa-check-circle text-success"></i> Kuchli parol';
    } else if (strength >= 40) {
      reqStrong.innerHTML = '<i class="fas fa-exclamation-circle text-warning"></i> O\'rtacha parol';
    } else {
      reqStrong.innerHTML = '<i class="fas fa-circle text-muted" style="font-size: 6px;"></i> Kuchli parol tavsiya etiladi';
    }
  }

  // Form submit
  form.addEventListener('submit', function(e) {
    const un = username.value.trim();
    const p1 = password1.value;
    const p2 = password2.value;
    
    // Username validatsiya
    if (un.length < 3) {
      e.preventDefault();
      alert('Login kamida 3 ta belgidan iborat bo\'lishi kerak!');
      username.focus();
      return;
    }

    if (!/^[a-zA-Z0-9_]+$/.test(un)) {
      e.preventDefault();
      alert('Login faqat lotin harflari, raqamlar va _ belgisidan iborat bo\'lishi kerak!');
      username.focus();
      return;
    }

    // Parol validatsiya
    if (p1.length < 6) {
      e.preventDefault();
      alert('Parol kamida 6 ta belgidan iborat bo\'lishi kerak!');
      password1.focus();
      return;
    }

    if (p1 !== p2) {
      e.preventDefault();
      alert('Parollar bir xil emas! Qaytadan kiriting.');
      password2.value = '';
      password2.focus();
      return;
    }

    // Kuchsiz parol haqida ogohlantirish
    const strength = checkPasswordStrength(p1);
    if (strength < 40) {
      const confirmed = confirm(
        'Sizning parolingiz juda zaif!\n\n' +
        'Xavfsizlik uchun kuchli parol tavsiya etiladi.\n\n' +
        'Davom etmoqchimisiz?'
      );
      
      if (!confirmed) {
        e.preventDefault();
        return;
      }
    }

    // Tugmani disable qilish
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saqlanmoqda...';
  });

  // Caps Lock ogohlantirishi
  password1.addEventListener('keyup', checkCapsLock);
  password2.addEventListener('keyup', checkCapsLock);

  function checkCapsLock(e) {
    if (e.getModifierState && e.getModifierState('CapsLock')) {
      if (!document.getElementById('capsWarning')) {
        const warning = document.createElement('small');
        warning.id = 'capsWarning';
        warning.className = 'text-warning d-block mt-1';
        warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Caps Lock yoniq!';
        e.target.parentElement.after(warning);
      }
    } else {
      const warning = document.getElementById('capsWarning');
      if (warning) warning.remove();
    }
  }
});
</script>

<style>
/* Success button hover effect */
.btn-success:hover {
  background-color: #218838 !important;
  border-color: #1e7e34 !important;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
}

/* Input focus */
input[type="password"]:focus,
input[type="text"]:focus {
  border-color: #28a745;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Progress bar animatsiya */
.progress-bar {
  transition: width 0.3s ease, background-color 0.3s ease;
}

/* Requirements list animatsiya */
#requirements li {
  transition: all 0.3s ease;
}

/* Form animatsiya */
.form-control {
  transition: all 0.2s ease;
}

.form-control:focus {
  transform: scale(1.01);
}

/* Username input style */
#username {
  text-transform: lowercase;
}
</style>
{% endblock extra_js %}